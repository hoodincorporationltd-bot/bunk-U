<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Present Sir</title>
    <!-- The user's original script tag for app.js is removed as the JS is now inline -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/date-fns@2.29.3/esm/index.js" type="module"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8f9fa; }
        .chart-container { position: relative; width: 100%; max-width: 800px; margin-left: auto; margin-right: auto; height: 300px; max-height: 40vh; }
        .tab-active { border-bottom-color: #4f46e5; color: #4f46e5; font-weight: 600; }
        .tab-inactive { border-bottom-color: transparent; color: #6b7280; }
        .status-green { background-color: #dcfce7; border-left-color: #22c55e; border-left-width: 4px;} .bar-green { background-color: #22c55e; } .text-green-800 { color: #166534; }
        .status-yellow { background-color: #fef9c3; border-left-color: #facc15; border-left-width: 4px;} .bar-yellow { background-color: #facc15; } .text-yellow-800 { color: #854d0e; }
        .status-red { background-color: #fee2e2; border-left-color: #ef4444; border-left-width: 4px;} .bar-red { background-color: #ef4444; } .text-red-800 { color: #991b1b; }
        .spinner { border: 4px solid rgba(0, 0, 0, 0.1); width: 36px; height: 36px; border-radius: 50%; border-left-color: #4f46e5; animation: spin 1s ease infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .priority-star { color: #d1d5db; transition: color 0.2s; }
        .priority-star.selected { color: #facc15; }
        .calendar-day { min-height: 120px; }
        .calendar-day.other-month { background-color: #f3f4f6; }
        .toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background-color: #333; color: white; padding: 10px 20px; border-radius: 8px; z-index: 100; opacity: 0; transition: opacity 0.5s; }
        .toast.show { opacity: 1; }
    </style>
</head>
<body class="text-gray-800">

    <div id="app" class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">
        
        <header class="mb-8 text-center">
            <h1 class="text-5xl font-extrabold text-gray-900 tracking-tight">Present Sir</h1>
            <p class="mt-2 text-lg text-gray-600">Your AI-powered dashboard for strategic academic compliance.</p>
        </header>

        <main>
            <div class="border-b border-gray-200 mb-6">
                <nav class="-mb-px flex space-x-6" aria-label="Tabs">
                    <button id="tab-dashboard" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm"><i class="fas fa-chart-pie mr-2"></i>Dashboard</button>
                    <button id="tab-daily" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm"><i class="fas fa-check-to-slot mr-2"></i>Daily Log</button>
                    <button id="tab-planner" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm"><i class="fas fa-calendar-alt mr-2"></i>Planner</button>
                    <button id="tab-settings" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm"><i class="fas fa-cog mr-2"></i>Settings</button>
                </nav>
            </div>

            <div id="page-dashboard">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                    <div class="lg:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-6">
                         <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                            <div class="flex justify-between items-center">
                                <h3 class="text-sm font-medium text-gray-500">Safe Absences Left</h3>
                                <div id="kpi-period-toggle" class="flex text-xs bg-gray-100 p-1 rounded-md">
                                    <button data-period="week" class="px-2 py-1 rounded">Week</button>
                                    <button data-period="month" class="px-2 py-1 rounded">Month</button>
                                    <button data-period="total" class="px-2 py-1 rounded bg-white shadow-sm font-semibold">Total</button>
                                </div>
                            </div>
                            <p id="kpi-safe-absences" class="mt-2 text-5xl font-bold text-indigo-600">0</p>
                            <p id="kpi-safe-absences-subtitle" class="text-xs text-gray-500 mt-1">Across all subjects</p>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                            <h3 class="text-sm font-medium text-gray-500">Overall Attendance</h3>
                            <p id="kpi-overall-attendance" class="mt-2 text-5xl font-bold text-indigo-600">0%</p>
                            <p class="text-xs text-gray-500 mt-1">Semester Average</p>
                        </div>
                    </div>
                    <div class="bg-indigo-50 p-6 rounded-xl border border-indigo-200">
                        <h3 class="text-sm font-medium text-indigo-800">Next Recommended Skip</h3>
                        <div id="recommendation-card" class="mt-2">
                            <p class="text-2xl font-semibold text-indigo-900">None Available</p>
                            <p class="text-xs text-indigo-700 mt-1">All subjects are within the safe buffer.</p>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                    <h2 class="text-lg font-semibold text-gray-900 mb-1">Your Subjects</h2>
                    <p class="text-sm text-gray-600 mb-4">A summary of your current attendance. Click any subject for a detailed analysis.</p>
                    <div id="subjects-list" class="space-y-4"></div>
                </div>
            </div>

            <div id="page-daily" class="hidden">
                 <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                    <div class="flex justify-between items-center mb-4">
                        <div>
                            <h2 class="text-lg font-semibold text-gray-900">Log Attendance for Today</h2>
                            <p id="daily-log-date" class="text-sm text-gray-600"></p>
                        </div>
                        <button id="undo-btn" class="px-3 py-1.5 text-sm font-medium text-gray-700 bg-gray-200 rounded-md hover:bg-gray-300 disabled:opacity-50 disabled:cursor-not-allowed" disabled><i class="fas fa-undo mr-2"></i>Undo</button>
                    </div>
                    <div id="daily-log-list" class="space-y-3"></div>
                </div>
            </div>

            <div id="page-planner" class="hidden">
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                    <div id="calendar-header" class="flex items-center justify-between mb-4">
                        <button id="prev-month-btn" class="p-2 rounded-md hover:bg-gray-100"><i class="fas fa-chevron-left"></i></button>
                        <h2 id="calendar-month-year" class="text-lg font-semibold"></h2>
                        <button id="next-month-btn" class="p-2 rounded-md hover:bg-gray-100"><i class="fas fa-chevron-right"></i></button>
                    </div>
                    <div id="calendar-grid" class="grid grid-cols-7 gap-1"></div>
                </div>
            </div>

            <div id="page-settings" class="hidden">
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                    <h2 class="text-xl font-bold text-gray-900 mb-6">Application Settings</h2>
                    <div class="space-y-10 divide-y divide-gray-200">
                        
                        <div class="pt-6">
                            <h3 class="text-lg font-semibold text-gray-800">Schedule Setup</h3>
                            <p class="text-sm text-gray-600 mb-4">Get started by importing your schedule.</p>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div class="border border-gray-200 rounded-lg p-4 space-y-4">
                                    <h4 class="font-semibold text-gray-700"><i class="fas fa-magic-wand-sparkles mr-2 text-indigo-500"></i>Import from Image (AI)</h4>
                                    <p class="text-xs text-gray-500 -mt-2">Upload your timetable and academic calendar for the most accurate setup.</p>
                                    <div>
                                        <label for="timetable-upload" class="block text-sm font-medium text-gray-700">1. Upload Daily Timetable (Required)</label>
                                        <input type="file" id="timetable-upload" accept="image/*" class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100 cursor-pointer"/>
                                    </div>
                                    <div>
                                        <label for="calendar-upload" class="block text-sm font-medium text-gray-700">2. Upload Academic Calendar (Recommended)</label>
                                        <input type="file" id="calendar-upload" accept="image/*" class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100 cursor-pointer"/>
                                    </div>
                                    <div class="flex items-center space-x-4 pt-2">
                                        <button id="process-uploads-btn" class="w-full px-4 py-2 bg-indigo-600 text-white text-sm font-medium rounded-md hover:bg-indigo-700">Process Uploads</button>
                                        <div id="ocr-spinner" class="spinner hidden"></div>
                                    </div>
                                </div>
                                <div class="border border-gray-200 rounded-lg p-4">
                                     <h4 class="font-semibold text-gray-700"><i class="fas fa-users mr-2 text-indigo-500"></i>Import with Class Code</h4>
                                     <p class="text-xs text-gray-500 mt-1 mb-3">Got a code from a friend? Enter it here to load the schedule.</p>
                                     <div class="flex space-x-2">
                                        <input type="text" id="class-code-input" placeholder="Enter Class Code" class="flex-grow rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                                        <button id="import-code-btn" class="px-4 py-2 bg-indigo-600 text-white text-sm font-medium rounded-md hover:bg-indigo-700">Import</button>
                                     </div>
                                </div>
                            </div>
                        </div>

                        <div id="my-schedule-section" class="pt-8 hidden">
                            <h3 class="text-lg font-semibold text-gray-800">My Schedule & Priorities</h3>
                            <p class="text-sm text-gray-600 mb-4">Review your schedule, set subject priorities, and share with classmates. You can edit any detail here at any time.</p>
                            <div class="mb-4 p-4 bg-blue-50 border border-blue-200 rounded-lg flex items-center justify-between">
                               <div>
                                 <h4 class="font-semibold text-blue-800">Share Your Schedule!</h4>
                                 <p class="text-sm text-blue-700">Your Class Code is: <strong id="share-code-display" class="text-lg select-all"></strong></p>
                               </div>
                               <button id="copy-code-btn" class="px-3 py-1.5 text-sm font-medium text-blue-700 bg-blue-200 rounded-md hover:bg-blue-300"><i class="fas fa-copy mr-2"></i>Copy</button>
                            </div>
                            <div id="manual-entry-table-header" class="grid grid-cols-1 md:grid-cols-7 gap-4 px-3 py-2 text-xs font-medium text-gray-500 uppercase">
                                <span class="md:col-span-2">Subject Name</span>
                                <span>Code</span>
                                <span>Total Classes</span>
                                <span>Held</span>
                                <span>Attended</span>
                                <span>Action</span>
                            </div>
                            <div id="manual-entry-table" class="space-y-2"></div>
                             <div class="mt-4">
                                <button id="add-subject-btn" class="px-4 py-2 bg-gray-600 text-white text-sm font-medium rounded-md hover:bg-gray-700"><i class="fas fa-plus mr-2"></i>Add Subject Manually</button>
                            </div>
                        </div>
                        
                        <div class="pt-8">
                            <h3 class="text-lg font-semibold text-gray-800">Preferences</h3>
                             <div class="mt-4">
                                <label for="min-attendance-input" class="block text-sm font-medium text-gray-700">Minimum Attendance Requirement</label>
                                <div class="flex items-center space-x-2 mt-1">
                                    <input type="number" id="min-attendance-input" class="w-24 rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" value="75">
                                    <span class="text-gray-700">%</span>
                                </div>
                            </div>
                        </div>

                        <div class="pt-8">
                            <h3 class="text-lg font-semibold text-gray-800">Data Management</h3>
                            <p class="text-sm text-gray-600 mb-4">Export your data or reset the application.</p>
                            <div class="flex flex-wrap gap-2">
                                <button id="export-csv-btn" class="px-4 py-2 bg-green-600 text-white text-sm font-medium rounded-md hover:bg-green-700"><i class="fas fa-file-csv mr-2"></i>Export as CSV</button>
                                <button id="export-json-btn" class="px-4 py-2 bg-blue-600 text-white text-sm font-medium rounded-md hover:bg-blue-700"><i class="fas fa-file-code mr-2"></i>Export as JSON</button>
                                <button id="reset-btn" class="px-4 py-2 bg-red-600 text-white text-sm font-medium rounded-md hover:bg-red-700"><i class="fas fa-trash mr-2"></i>Reset All Data</button>
                            </div>
                        </div>

                        <div class="pt-8">
                            <h3 class="text-lg font-semibold text-gray-800">Feedback & Future</h3>
                             <div class="flex flex-wrap gap-4">
                                <div class="flex-1 min-w-[250px] bg-gray-50 p-4 rounded-lg border">
                                    <h4 class="font-semibold text-gray-700">Have an idea?</h4>
                                    <p class="text-sm text-gray-600 my-2">We'd love to hear your feedback to make this app even better.</p>
                                    <a href="mailto:feedback@example.com?subject=Present%20Sir%20Feedback" class="inline-block px-4 py-2 bg-gray-600 text-white text-sm font-medium rounded-md hover:bg-gray-700"><i class="fas fa-envelope mr-2"></i>Send Feedback</a>
                                </div>
                                <div class="flex-1 min-w-[250px] bg-gray-50 p-4 rounded-lg border">
                                    <h4 class="font-semibold text-gray-700">Coming Soon...</h4>
                                    <p class="text-sm text-gray-600 my-2">AI-powered strategic absence planning and calendar integration.</p>
                                    <p class="text-indigo-600 font-semibold">Stay Tuned!</p>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
            
        </main>
    </div>

    <div id="modal-container" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 hidden z-50">
        <div id="modal-content" class="bg-white rounded-2xl shadow-xl w-full max-w-4xl max-h-[90vh] overflow-y-auto p-6 sm:p-8">
        </div>
    </div>
    
    <div id="toast-container" class="toast"></div>

    <script type="module">
        import { startOfWeek, endOfWeek, startOfMonth, endOfMonth, eachDayOfInterval, format, isSameMonth, isToday, parseISO, addDays, getDay, parse } from 'https://cdn.jsdelivr.net/npm/date-fns@2.29.3/esm/index.js';
        
        // Import Firebase SDKs
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";


        document.addEventListener('DOMContentLoaded', () => {
            const API_KEY = "YOUR_GEMINI_API_KEY"; // Use your Gemini API Key here

            // --- Firebase Configuration ---
            // IMPORTANT: Replace this with your own Firebase project's configuration!
            const firebaseConfig = {
                apiKey: "AIzaSyCwk--JN91Qu4clLwq-7oZXNus3NwQXcrw",
                authDomain: "bunk-u.firebaseapp.com",
                projectId: "bunk-u",
                storageBucket: "bunk-u.appspot.com",
                messagingSenderId: "1093144919119",
                appId: "1:1093144919119:web:1f7a82803ff1300143be3a"
            };

            // --- CHECK FIREBASE CONFIGURATION ---
            if (!firebaseConfig.apiKey || firebaseConfig.apiKey.startsWith("YOUR_")) {
                document.getElementById('app').innerHTML = `
                    <div class="bg-red-100 border-l-4 border-red-500 text-red-700 p-6 rounded-xl shadow-md max-w-3xl mx-auto mt-12" role="alert">
                        <h2 class="font-bold text-xl">Configuration Error</h2>
                        <p class="mt-2">The application cannot connect to the database. Please configure Firebase and the Gemini API Key.</p>
                        <p class="mt-4 font-semibold">Please follow these steps:</p>
                        <ol class="list-decimal list-inside mt-2 space-y-1 text-sm">
                            <li>Go to the <a href="https://console.firebase.google.com/" target="_blank" class="text-blue-600 hover:underline font-semibold">Firebase Console</a> and create a project.</li>
                            <li>In your Project Settings, find the "Your apps" card and copy the <code>firebaseConfig</code> object.</li>
                            <li>In the code editor, find the <code>firebaseConfig</code> object and replace the placeholder values.</li>
                            <li>Go to <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-blue-600 hover:underline font-semibold">Google AI Studio</a> to get a Gemini API key.</li>
                            <li>In the code editor, find the <code>API_KEY</code> constant and replace the placeholder value.</li>
                        </ol>
                    </div>
                `;
                return; // Stop the script from running further.
            }

            // --- Initialize Firebase ---
            const app = initializeApp(firebaseConfig);
            const db = getFirestore(app);
            const auth = getAuth(app);

            let userId = null; // To store the user's unique ID

            const state = {
                minAttendance: 75,
                subjects: [],
                history: {}, // { "subjectId-date": "Present" | "Absent" | "Cancelled" }
                lastAction: null,
                shareCode: null,
            };

            const elements = {
                tabs: {
                    dashboard: document.getElementById('tab-dashboard'),
                    daily: document.getElementById('tab-daily'),
                    planner: document.getElementById('tab-planner'),
                    settings: document.getElementById('tab-settings'),
                },
                pages: {
                    dashboard: document.getElementById('page-dashboard'),
                    daily: document.getElementById('page-daily'),
                    planner: document.getElementById('page-planner'),
                    settings: document.getElementById('page-settings'),
                },
                kpi: {
                    periodToggle: document.getElementById('kpi-period-toggle'),
                    safeAbsences: document.getElementById('kpi-safe-absences'),
                    safeAbsencesSubtitle: document.getElementById('kpi-safe-absences-subtitle'),
                    overallAttendance: document.getElementById('kpi-overall-attendance'),
                },
                dashboard: {
                    subjectsList: document.getElementById('subjects-list'),
                    recommendationCard: document.getElementById('recommendation-card'),
                },
                dailyLog: {
                    date: document.getElementById('daily-log-date'),
                    list: document.getElementById('daily-log-list'),
                    undoBtn: document.getElementById('undo-btn'),
                },
                planner: {
                    header: document.getElementById('calendar-header'),
                    prevMonthBtn: document.getElementById('prev-month-btn'),
                    nextMonthBtn: document.getElementById('next-month-btn'),
                    monthYear: document.getElementById('calendar-month-year'),
                    grid: document.getElementById('calendar-grid'),
                },
                settings: {
                    minAttendanceInput: document.getElementById('min-attendance-input'),
                    timetableUpload: document.getElementById('timetable-upload'),
                    calendarUpload: document.getElementById('calendar-upload'),
                    processUploadsBtn: document.getElementById('process-uploads-btn'),
                    ocrSpinner: document.getElementById('ocr-spinner'),
                    classCodeInput: document.getElementById('class-code-input'),
                    importCodeBtn: document.getElementById('import-code-btn'),
                    myScheduleSection: document.getElementById('my-schedule-section'),
                    manualEntryTable: document.getElementById('manual-entry-table'),
                    addSubjectBtn: document.getElementById('add-subject-btn'),
                    shareCodeDisplay: document.getElementById('share-code-display'),
                    copyCodeBtn: document.getElementById('copy-code-btn'),
                    exportCsvBtn: document.getElementById('export-csv-btn'),
                    exportJsonBtn: document.getElementById('export-json-btn'),
                    resetBtn: document.getElementById('reset-btn'),
                },
                modal: {
                    container: document.getElementById('modal-container'),
                    content: document.getElementById('modal-content'),
                },
                toast: document.getElementById('toast-container'),
            };

            let currentPlannerDate = new Date();
            let chartInstance = null;
            let activeTab = 'dashboard';
            let activePeriod = 'total';

            // --- Data Persistence Functions (Firestore) ---
            async function saveData() {
                if (!userId) return; // Don't save if no user is logged in
                try {
                    const userDocRef = doc(db, 'users', userId);
                    await setDoc(userDocRef, state);
                } catch (e) {
                    console.error("Failed to save data to Firestore", e);
                    showToast("Error saving data.", 'error');
                }
            }

            async function loadData() {
                if (!userId) return; // Don't load if no user is logged in
                const userDocRef = doc(db, 'users', userId);
                const docSnap = await getDoc(userDocRef);

                if (docSnap.exists()) {
                    const loadedState = docSnap.data();
                    Object.assign(state, loadedState);
                } else {
                    console.log("No previous data found for this user. Starting fresh.");
                }
                updateApp(); // Update the UI after data is loaded
            }

            function showToast(message, type = 'success') {
                elements.toast.textContent = message;
                elements.toast.className = `toast show ${type === 'error' ? 'bg-red-600' : 'bg-gray-800'}`;
                setTimeout(() => {
                    elements.toast.classList.remove('show');
                }, 3000);
            }

            function calculateAttendance(subjectId, endDate = new Date()) {
                const subject = state.subjects.find(s => s.id === subjectId);
                if (!subject) return null;

                const historyKeys = Object.keys(state.history).filter(key => key.startsWith(`${subjectId}-`));
                const relevantHistory = historyKeys.map(key => ({
                    date: parseISO(key.split('-')[1]),
                    status: state.history[key]
                })).filter(h => h.date <= endDate);

                const attended = relevantHistory.filter(h => h.status === 'Present').length;
                const absent = relevantHistory.filter(h => h.status === 'Absent').length;
                const classesHeldSoFar = attended + absent;
                
                const totalClasses = subject.totalClasses || 0;
                const currentPercentage = classesHeldSoFar > 0 ? (attended / classesHeldSoFar) * 100 : 100;
                const maxAllowedAbsences = Math.floor(totalClasses * (1 - state.minAttendance / 100));
                const safeAbsencesRemaining = maxAllowedAbsences - absent;

                return {
                    attended,
                    absent,
                    classesHeldSoFar,
                    totalClasses,
                    currentPercentage,
                    safeAbsencesRemaining,
                };
            }

            function getStatusColor(percentage) {
                const buffer = 5;
                if (percentage < state.minAttendance) return 'red';
                if (percentage < state.minAttendance + buffer) return 'yellow';
                return 'green';
            }
            
            function renderDashboard() {
                if (state.subjects.length === 0) {
                    elements.dashboard.subjectsList.innerHTML = `<div class="text-center py-8 text-gray-500">
                        <p class="text-lg">Welcome to Present Sir!</p>
                        <p class="mt-2 text-sm">Go to Settings to import your schedule and get started.</p>
                    </div>`;
                    elements.dashboard.recommendationCard.innerHTML = `<p class="text-2xl font-semibold text-indigo-900">Setup Required</p>
                                <p class="text-xs text-indigo-700 mt-1">Import your schedule in Settings.</p>`;
                    elements.kpi.safeAbsences.textContent = '0';
                    elements.kpi.overallAttendance.textContent = 'N/A';
                    return;
                }

                elements.dashboard.subjectsList.innerHTML = '';
                let totalPercentageSum = 0;
                let subjectsWithStats = [];

                state.subjects.forEach(subject => {
                    const stats = calculateAttendance(subject.id);
                    if(!stats) return;

                    totalPercentageSum += stats.currentPercentage;
                    subjectsWithStats.push({ ...subject, ...stats });

                    const color = getStatusColor(stats.currentPercentage);
                    const subjectEl = document.createElement('div');
                    subjectEl.className = `p-4 rounded-lg border cursor-pointer hover:shadow-md transition-shadow duration-200 status-${color}`;
                    subjectEl.dataset.subjectId = subject.id;
                    subjectEl.innerHTML = `
                        <div class="flex flex-col sm:flex-row justify-between sm:items-center">
                            <div>
                                <div class="flex items-center">
                                    <p class="font-semibold text-gray-800">${subject.name}</p>
                                    <div class="flex ml-2">${[...Array(5)].map((_, i) => `<i class="fas fa-star text-xs ${i < subject.priority ? 'text-yellow-400' : 'text-gray-300'}"></i>`).join('')}</div>
                                </div>
                                <p class="text-sm text-gray-600">${subject.code} - ${subject.type}</p>
                                <p class="text-xs text-gray-500 mt-1">Attended: ${stats.attended} of ${stats.classesHeldSoFar} classes held</p>
                            </div>
                            <div class="flex items-center space-x-4 mt-2 sm:mt-0">
                                <div class="text-center">
                                    <p class="font-bold text-lg text-${color}-800">${stats.currentPercentage.toFixed(1)}%</p>
                                    <p class="text-xs text-gray-500">Current</p>
                                </div>
                                <div class="text-center">
                                    <p class="font-bold text-lg text-${color}-800">${stats.safeAbsencesRemaining}</p>
                                    <p class="text-xs text-gray-500">Safe Skips</p>
                                </div>
                            </div>
                        </div>
                        <div class="mt-3 w-full bg-gray-200 rounded-full h-2.5">
                            <div class="h-2.5 rounded-full bar-${color}" style="width: ${stats.currentPercentage}%"></div>
                        </div>
                    `;
                    subjectEl.addEventListener('click', () => showSubjectDetail(subject.id));
                    elements.dashboard.subjectsList.appendChild(subjectEl);
                });

                elements.kpi.overallAttendance.textContent = state.subjects.length > 0 ? `${(totalPercentageSum / state.subjects.length).toFixed(1)}%` : 'N/A';
                
                updateKPIs();
                updateRecommendation(subjectsWithStats);
            }

            function updateKPIs() {
                const now = new Date();
                let interval;
                let subtitle = 'Across all subjects';

                if (activePeriod === 'week') {
                    interval = { start: startOfWeek(now), end: endOfWeek(now) };
                    subtitle = 'For this week';
                } else if (activePeriod === 'month') {
                    interval = { start: startOfMonth(now), end: endOfMonth(now) };
                    subtitle = 'For this month';
                }

                let periodAbsences = 0;
                let totalSafeAbsences = 0;

                state.subjects.forEach(subject => {
                    const stats = calculateAttendance(subject.id);
                    if(!stats) return;
                    totalSafeAbsences += stats.safeAbsencesRemaining > 0 ? stats.safeAbsencesRemaining : 0;

                    if (interval) {
                         const historyKeys = Object.keys(state.history).filter(key => key.startsWith(`${subject.id}-`));
                         const periodHistory = historyKeys.map(key => ({
                            date: parseISO(key.split('-')[1]),
                            status: state.history[key]
                         })).filter(h => h.date >= interval.start && h.date <= interval.end && h.status === 'Absent');
                         periodAbsences += periodHistory.length;
                    }
                });

                if (activePeriod === 'total') {
                    elements.kpi.safeAbsences.textContent = totalSafeAbsences;
                    subtitle = `Across all subjects`;
                } else {
                    elements.kpi.safeAbsences.textContent = periodAbsences;
                    subtitle = `Absences ${activePeriod === 'week' ? 'this week' : 'this month'}`;
                }
                 elements.kpi.safeAbsencesSubtitle.textContent = subtitle;

                document.querySelectorAll('#kpi-period-toggle button').forEach(btn => {
                    btn.classList.remove('bg-white', 'shadow-sm', 'font-semibold');
                    if (btn.dataset.period === activePeriod) {
                        btn.classList.add('bg-white', 'shadow-sm', 'font-semibold');
                    }
                });
            }

            function updateRecommendation(subjectsWithStats) {
                const potentialSkips = subjectsWithStats
                    .filter(s => s.safeAbsencesRemaining > 0)
                    .sort((a, b) => {
                        if (a.priority !== b.priority) {
                            return a.priority - b.priority; // Lower priority first
                        }
                        return b.currentPercentage - a.currentPercentage; // Higher percentage first
                    });

                if (potentialSkips.length > 0) {
                    const bestBet = potentialSkips[0];
                    elements.dashboard.recommendationCard.innerHTML = `
                        <p class="text-2xl font-semibold text-indigo-900">${bestBet.name}</p>
                        <p class="text-xs text-indigo-700 mt-1">Priority: ${[...Array(5)].map((_, i) => `<i class="fas fa-star ${i < bestBet.priority ? 'text-indigo-500' : 'text-indigo-200'}"></i>`).join('')} | Current: ${bestBet.currentPercentage.toFixed(1)}%</p>
                    `;
                } else {
                    elements.dashboard.recommendationCard.innerHTML = `
                        <p class="text-2xl font-semibold text-indigo-900">None Available</p>
                        <p class="text-xs text-indigo-700 mt-1">All subjects are below the safe buffer.</p>
                    `;
                }
            }
            
            function renderDailyLog() {
                const todayStr = format(new Date(), 'yyyy-MM-dd');
                elements.dailyLog.date.textContent = format(new Date(), 'EEEE, MMMM d');
                elements.dailyLog.list.innerHTML = '';

                const todayClasses = state.subjects; // Assuming all subjects can have a class today
                if (todayClasses.length === 0) {
                     elements.dailyLog.list.innerHTML = `<div class="text-center py-8 text-gray-500"><p>No subjects scheduled. Go to Settings to set up your timetable.</p></div>`;
                       return;
                }

                let allLogged = true;
                todayClasses.forEach(subject => {
                    const historyKey = `${subject.id}-${todayStr}`;
                    const status = state.history[historyKey];
                    const stats = calculateAttendance(subject.id);

                    if (!status) allLogged = false;

                    const logEl = document.createElement('div');
                    logEl.className = 'flex flex-col sm:flex-row justify-between items-center p-3 bg-gray-50 rounded-lg border';
                    logEl.innerHTML = `
                        <div class="w-full sm:w-1/3 mb-2 sm:mb-0">
                            <p class="font-medium">${subject.name}</p>
                            <p class="text-sm text-gray-500">${subject.time || ''}</p>
                        </div>
                        <div class="w-full sm:w-1/3 mb-2 sm:mb-0">
                            <div class="w-full bg-gray-200 rounded-full h-2.5">
                                <div class="h-2.5 rounded-full bar-${getStatusColor(stats.currentPercentage)}" style="width: ${stats.currentPercentage}%"></div>
                            </div>
                            <p class="text-xs text-gray-500 text-center mt-1">${stats.currentPercentage.toFixed(1)}%</p>
                        </div>
                        <div class="flex space-x-2">
                            <button data-subject-id="${subject.id}" data-status="Present" class="log-btn px-3 py-1.5 text-sm font-medium text-white bg-green-600 rounded-md hover:bg-green-700 ${status === 'Present' ? 'ring-2 ring-offset-2 ring-green-500' : ''}"><i class="fas fa-check"></i></button>
                            <button data-subject-id="${subject.id}" data-status="Absent" class="log-btn px-3 py-1.5 text-sm font-medium text-white bg-red-600 rounded-md hover:bg-red-700 ${status === 'Absent' ? 'ring-2 ring-offset-2 ring-red-500' : ''}"><i class="fas fa-times"></i></button>
                            <button data-subject-id="${subject.id}" data-status="Cancelled" class="log-btn px-3 py-1.5 text-sm font-medium text-white bg-gray-500 rounded-md hover:bg-gray-600 ${status === 'Cancelled' ? 'ring-2 ring-offset-2 ring-gray-400' : ''}"><i class="fas fa-ban"></i></button>
                        </div>
                    `;
                    elements.dailyLog.list.appendChild(logEl);
                });

                document.querySelectorAll('.log-btn').forEach(btn => btn.addEventListener('click', handleLogAction));

                if (allLogged && todayClasses.length > 0) {
                    showMemeModal();
                }
            }

            function handleLogAction(e) {
                const subjectId = parseInt(e.currentTarget.dataset.subjectId, 10);
                const { status } = e.currentTarget.dataset;
                const todayStr = format(new Date(), 'yyyy-MM-dd');
                const historyKey = `${subjectId}-${todayStr}`;
                const oldStatus = state.history[historyKey];

                state.lastAction = {
                    key: historyKey,
                    oldStatus: oldStatus || null,
                    newStatus: status
                };
                
                if (oldStatus === status) { 
                    delete state.history[historyKey];
                    state.lastAction.newStatus = null;
                } else {
                    state.history[historyKey] = status;
                }

                elements.dailyLog.undoBtn.disabled = false;
                updateApp();
            }

            function undoLastAction() {
                if (!state.lastAction) return;
                const { key, oldStatus } = state.lastAction;
                if (oldStatus) {
                    state.history[key] = oldStatus;
                } else {
                    delete state.history[key];
                }
                state.lastAction = null;
                elements.dailyLog.undoBtn.disabled = true;
                updateApp();
                showToast('Last action undone.');
            }

            function renderPlanner() {
                elements.planner.monthYear.textContent = format(currentPlannerDate, 'MMMM yyyy');
                elements.planner.grid.innerHTML = '';

                const daysOfWeek = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
                daysOfWeek.forEach(day => {
                    elements.planner.grid.innerHTML += `<div class="text-center font-semibold text-xs text-gray-500 py-2">${day}</div>`;
                });

                const monthStart = startOfMonth(currentPlannerDate);
                const monthEnd = endOfMonth(currentPlannerDate);
                const daysInMonth = eachDayOfInterval({ start: monthStart, end: monthEnd });

                for (let i = 0; i < monthStart.getDay(); i++) {
                    elements.planner.grid.innerHTML += `<div class="calendar-day other-month"></div>`;
                }

                daysInMonth.forEach(day => {
                    const dayStr = format(day, 'yyyy-MM-dd');
                    const dayClasses = state.subjects.map(subject => {
                        const status = state.history[`${subject.id}-${dayStr}`];
                        if (!status) return '';
                        let colorClass = '';
                        if (status === 'Present') colorClass = 'bg-green-100 text-green-800';
                        else if (status === 'Absent') colorClass = 'bg-red-100 text-red-800';
                        else if (status === 'Cancelled') colorClass = 'bg-gray-200 text-gray-600';
                        return `<div class="text-xs p-1 rounded-md mt-1 ${colorClass}">${subject.code}</div>`;
                    }).join('');

                    const isCurrentToday = isToday(day);
                    elements.planner.grid.innerHTML += `
                        <div class="calendar-day border border-gray-200 p-2 ${!isSameMonth(day, currentPlannerDate) ? 'other-month' : ''}">
                            <div class="text-sm text-right ${isCurrentToday ? 'bg-indigo-600 text-white rounded-full w-6 h-6 flex items-center justify-center' : ''}">${format(day, 'd')}</div>
                            <div class="mt-1">${dayClasses}</div>
                        </div>
                    `;
                });
            }

            function renderSettings() {
                elements.settings.minAttendanceInput.value = state.minAttendance;
                if (state.subjects.length > 0) {
                    elements.settings.myScheduleSection.classList.remove('hidden');
                    renderManualEntryTable();
                    if (state.shareCode) {
                        elements.settings.shareCodeDisplay.textContent = state.shareCode;
                    }
                } else {
                    elements.settings.myScheduleSection.classList.add('hidden');
                }
            }

            function renderManualEntryTable() {
                elements.settings.manualEntryTable.innerHTML = '';
                state.subjects.forEach(subject => {
                    const stats = calculateAttendance(subject.id);
                    const row = document.createElement('div');
                    row.className = 'p-3 border rounded-lg bg-white grid grid-cols-1 md:grid-cols-7 gap-4 items-center';
                    row.innerHTML = `
                        <input data-id="${subject.id}" data-field="name" class="md:col-span-2 p-2 border rounded-md" value="${subject.name}" placeholder="Subject Name">
                        <input data-id="${subject.id}" data-field="code" class="p-2 border rounded-md" value="${subject.code}" placeholder="Code">
                        <input data-id="${subject.id}" data-field="totalClasses" type="number" class="p-2 border rounded-md" value="${subject.totalClasses}" placeholder="Total Classes">
                        <input data-id="${subject.id}" data-field="held" type="number" class="p-2 border rounded-md bg-gray-100 cursor-not-allowed" value="${stats.classesHeldSoFar}" readonly>
                        <input data-id="${subject.id}" data-field="attended" type="number" class="p-2 border rounded-md bg-gray-100 cursor-not-allowed" value="${stats.attended}" readonly>
                        <button data-id="${subject.id}" class="remove-subject-btn text-red-500 hover:text-red-700 justify-self-center"><i class="fas fa-trash"></i></button>
                    `;
                    elements.settings.manualEntryTable.appendChild(row);
                });

                document.querySelectorAll('#manual-entry-table input').forEach(input => {
                    input.addEventListener('change', handleSubjectUpdate);
                });
                document.querySelectorAll('.remove-subject-btn').forEach(btn => {
                    btn.addEventListener('click', handleRemoveSubject);
                });
            }
            
            function handleSubjectUpdate(e) {
                const { id, field } = e.target.dataset;
                const subjectId = parseInt(id, 10);
                const subject = state.subjects.find(s => s.id === subjectId);
                if (!subject) return;

                if (field === 'name' || field === 'code' || field === 'totalClasses') {
                    subject[field] = field === 'totalClasses' ? parseInt(e.target.value) : e.target.value;
                }
                updateApp();
            }

            function handleRemoveSubject(e) {
                const idToRemove = parseInt(e.currentTarget.dataset.id, 10);
                state.subjects = state.subjects.filter(s => s.id !== idToRemove);
                Object.keys(state.history).forEach(key => {
                    if (key.startsWith(`${idToRemove}-`)) {
                        delete state.history[key];
                    }
                });
                updateApp();
            }

            function showAddSubjectModal() {
                elements.modal.content.innerHTML = `
                    <form id="add-subject-form">
                        <h2 class="text-2xl font-bold text-gray-900 mb-4">Add New Subject</h2>
                        <div class="space-y-4">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Subject Name</label>
                                    <input name="name" type="text" required class="mt-1 p-2 border rounded-md w-full">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Subject Code</label>
                                    <input name="code" type="text" required class="mt-1 p-2 border rounded-md w-full">
                                </div>
                            </div>
                             <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Class Type</label>
                                    <input name="type" type="text" placeholder="e.g., Lecture" required class="mt-1 p-2 border rounded-md w-full">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Total Classes in Semester</label>
                                    <input name="totalClasses" type="number" required class="mt-1 p-2 border rounded-md w-full">
                                </div>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Classes Held So Far</label>
                                    <input name="held" type="number" value="0" required class="mt-1 p-2 border rounded-md w-full">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Classes Attended So Far</label>
                                    <input name="attended" type="number" value="0" required class="mt-1 p-2 border rounded-md w-full">
                                </div>
                            </div>
                        </div>
                        <div class="mt-6 flex justify-end space-x-3">
                            <button type="button" id="cancel-add-subject-btn" class="px-4 py-2 bg-gray-200 text-gray-800 text-sm font-medium rounded-md hover:bg-gray-300">Cancel</button>
                            <button type="submit" class="px-4 py-2 bg-indigo-600 text-white text-sm font-medium rounded-md hover:bg-indigo-700">Add Subject</button>
                        </div>
                    </form>
                `;
                elements.modal.container.classList.remove('hidden');

                document.getElementById('add-subject-form').addEventListener('submit', (e) => {
                    e.preventDefault();
                    const formData = new FormData(e.target);
                    const newId = state.subjects.length > 0 ? Math.max(...state.subjects.map(s => s.id)) + 1 : 1;
                    const held = parseInt(formData.get('held'));
                    const attended = parseInt(formData.get('attended'));

                    const newSubject = {
                        id: newId,
                        name: formData.get('name'),
                        code: formData.get('code'),
                        type: formData.get('type'),
                        totalClasses: parseInt(formData.get('totalClasses')),
                        priority: 3,
                    };

                    state.subjects.push(newSubject);
                    generateInitialHistory(newId, held, attended);
                    
                    updateApp();
                    closeModal();
                });

                document.getElementById('cancel-add-subject-btn').addEventListener('click', closeModal);
            }
            
            async function processUploads() {
                const timetableFile = elements.settings.timetableUpload.files[0];
                const calendarFile = elements.settings.calendarUpload.files[0];

                if (!timetableFile) {
                    showToast("Please upload a timetable image.", "error");
                    return;
                }

                elements.settings.ocrSpinner.classList.remove('hidden');
                elements.settings.processUploadsBtn.disabled = true;

                try {
                    const timetableBase64 = await readFileAsBase64(timetableFile);
                    const calendarBase64 = calendarFile ? await readFileAsBase64(calendarFile) : null;

                    const parts = [
                        { text: `
                            Analyze the provided images and return a JSON object with two keys: "weeklySchedule" and "calendarInfo".
                            1. For "weeklySchedule", analyze the timetable image. Extract each class into an object with "name", "code", "type", and "day" (e.g., "Monday", "Tuesday", etc.).
                            2. For "calendarInfo", analyze the academic calendar image. Extract the semester "startDate", "endDate", and an array of "holidays". All dates MUST be in "YYYY-MM-DD" format.
                            If the calendar image is not provided, return the "calendarInfo" key with null values.
                        ` },
                        { inlineData: { mimeType: timetableFile.type, data: timetableBase64 } }
                    ];

                    if (calendarBase64) {
                        parts.push({ inlineData: { mimeType: calendarFile.type, data: calendarBase64 } });
                    }
                    
                    const payload = { contents: [{ parts }], generationConfig: { responseMimeType: "application/json" } };

                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-pro-vision:generateContent?key=${API_KEY}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) throw new Error(`API Error: ${response.statusText}`);
                    const result = await response.json();
                    
                    const parsedJson = JSON.parse(result.candidates[0].content.parts[0].text);
                    
                    const subjectsWithTotals = calculateTotalClassesFromAI(parsedJson);

                    const extractedSubjects = subjectsWithTotals.map((s, index) => ({
                        id: Date.now() + index,
                        ...s,
                        priority: 3
                    }));

                    showOcrConfirmationModal(extractedSubjects);

                } catch (error) {
                    console.error("Error processing images with AI:", error);
                    showToast("Failed to process images. Please try again or enter manually.", "error");
                } finally {
                    elements.settings.ocrSpinner.classList.add('hidden');
                    elements.settings.processUploadsBtn.disabled = false;
                }
            }

            function calculateTotalClassesFromAI(aiData) {
                const { weeklySchedule, calendarInfo } = aiData;
                if (!weeklySchedule) return [];

                let startDate, endDate;
                if (calendarInfo && calendarInfo.startDate && calendarInfo.endDate) {
                    startDate = parse(calendarInfo.startDate, 'yyyy-MM-dd', new Date());
                    endDate = parse(calendarInfo.endDate, 'yyyy-MM-dd', new Date());
                } else {
                    startDate = new Date();
                    endDate = addDays(new Date(), 120);
                }

                const holidays = new Set(calendarInfo?.holidays || []);

                const subjectMap = new Map();
                weeklySchedule.forEach(item => {
                    const code = item.code || item.name;
                    if (!subjectMap.has(code)) {
                        subjectMap.set(code, {
                            name: item.name,
                            code: code,
                            type: item.type,
                            days: new Set()
                        });
                    }
                    const dayOfWeek = item.day.toLowerCase();
                    const dayMap = { 'sunday': 0, 'monday': 1, 'tuesday': 2, 'wednesday': 3, 'thursday': 4, 'friday': 5, 'saturday': 6 };
                    if (dayMap.hasOwnProperty(dayOfWeek)) {
                        subjectMap.get(code).days.add(dayMap[dayOfWeek]);
                    }
                });

                const finalSchedule = [];
                for (const subject of subjectMap.values()) {
                    let totalClasses = 0;
                    if (startDate && endDate && startDate < endDate) {
                        const daysInRange = eachDayOfInterval({ start: startDate, end: endDate });
                        daysInRange.forEach(day => {
                            const dayOfWeek = getDay(day);
                            const dateStr = format(day, 'yyyy-MM-dd');
                            if (subject.days.has(dayOfWeek) && !holidays.has(dateStr)) {
                                totalClasses++;
                            }
                        });
                    }
                    
                    finalSchedule.push({
                        name: subject.name,
                        code: subject.code,
                        type: subject.type,
                        totalClasses: totalClasses
                    });
                }
                return finalSchedule;
            }

            function readFileAsBase64(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.readAsDataURL(file);
                    reader.onload = () => resolve(reader.result.split(',')[1]);
                    reader.onerror = error => reject(error);
                });
            }

            function showOcrConfirmationModal(subjects) {
                 elements.modal.content.innerHTML = `
                    <div class="flex justify-between items-start">
                        <h2 class="text-2xl font-bold text-gray-900">Confirm Your Schedule</h2>
                        <button id="close-modal-btn" class="text-gray-400 hover:text-gray-600 text-3xl leading-none">&times;</button>
                    </div>
                    <p class="mt-2 text-sm text-gray-600">Our AI has extracted your schedule. Please review it and enter your current attendance status for each subject before confirming.</p>
                    <div id="ocr-confirm-table" class="mt-4 max-h-[60vh] overflow-y-auto border border-gray-200 rounded-lg">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50 sticky top-0">
                                <tr>
                                    <th class="px-2 py-2 text-left text-xs font-medium text-gray-500 uppercase">Subject</th>
                                    <th class="px-2 py-2 text-left text-xs font-medium text-gray-500 uppercase">Code</th>
                                    <th class="px-2 py-2 text-left text-xs font-medium text-gray-500 uppercase">Type</th>
                                    <th class="px-2 py-2 text-left text-xs font-medium text-gray-500 uppercase">Total Classes</th>
                                    <th class="px-2 py-2 text-left text-xs font-medium text-gray-500 uppercase">Held So Far</th>
                                    <th class="px-2 py-2 text-left text-xs font-medium text-gray-500 uppercase">Attended So Far</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                            ${subjects.map(s => `
                                <tr>
                                    <td class="px-2 py-2"><input data-id="${s.id}" data-field="name" class="p-1 border rounded w-full" value="${s.name}"></td>
                                    <td class="px-2 py-2"><input data-id="${s.id}" data-field="code" class="p-1 border rounded w-full" value="${s.code}"></td>
                                    <td class="px-2 py-2"><input data-id="${s.id}" data-field="type" class="p-1 border rounded w-full" value="${s.type}"></td>
                                    <td class="px-2 py-2"><input data-id="${s.id}" data-field="totalClasses" type="number" class="p-1 border rounded w-full" value="${s.totalClasses}"></td>
                                    <td class="px-2 py-2"><input data-id="${s.id}" data-field="held" type="number" class="p-1 border rounded w-full" value="0"></td>
                                    <td class="px-2 py-2"><input data-id="${s.id}" data-field="attended" type="number" class="p-1 border rounded w-full" value="0"></td>
                                </tr>
                            `).join('')}
                            </tbody>
                        </table>
                    </div>
                    <div class="mt-6 flex justify-end space-x-3">
                        <button id="cancel-ocr-btn" class="px-4 py-2 bg-gray-200 text-gray-800 text-sm font-medium rounded-md hover:bg-gray-300">Cancel</button>
                        <button id="confirm-ocr-btn" class="px-4 py-2 bg-indigo-600 text-white text-sm font-medium rounded-md hover:bg-indigo-700">Confirm & Update</button>
                    </div>
                `;
                elements.modal.container.classList.remove('hidden');

                document.getElementById('confirm-ocr-btn').addEventListener('click', () => {
                    const updatedSubjects = [];
                    state.history = {}; 

                    subjects.forEach(s => {
                        const row = document.querySelector(`#ocr-confirm-table input[data-id='${s.id}']`).closest('tr');
                        const name = row.querySelector(`[data-field='name']`).value;
                        const code = row.querySelector(`[data-field='code']`).value;
                        const type = row.querySelector(`[data-field='type']`).value;
                        const totalClasses = parseInt(row.querySelector(`[data-field='totalClasses']`).value);
                        const held = parseInt(row.querySelector(`[data-field='held']`).value);
                        const attended = parseInt(row.querySelector(`[data-field='attended']`).value);
                        
                        const newSubject = { ...s, name, code, type, totalClasses };
                        updatedSubjects.push(newSubject);
                        
                        if (held > 0) {
                            generateInitialHistory(newSubject.id, held, attended);
                        }
                    });

                    state.subjects = updatedSubjects;
                    generateShareCode();
                    updateApp();
                    closeModal();
                    switchTab('dashboard');
                });
                document.getElementById('cancel-ocr-btn').addEventListener('click', closeModal);
                document.getElementById('close-modal-btn').addEventListener('click', closeModal);
            }

            function generateInitialHistory(subjectId, held, attended) {
                if (held < attended) {
                    showToast(`For subject ${subjectId}, attended classes cannot be more than held classes.`, 'error');
                    return;
                }
                const absent = held - attended;
                let date = new Date(2000, 0, 1);

                for (let i = 0; i < attended; i++) {
                    const historyKey = `${subjectId}-${format(date, 'yyyy-MM-dd')}`;
                    state.history[historyKey] = 'Present';
                    date = addDays(date, 1);
                }
                for (let i = 0; i < absent; i++) {
                    const historyKey = `${subjectId}-${format(date, 'yyyy-MM-dd')}`;
                    state.history[historyKey] = 'Absent';
                    date = addDays(date, 1);
                }
            }
            
            async function generateShareCode() {
                const code = Math.random().toString(36).substring(2, 8).toUpperCase();
                state.shareCode = code;

                const scheduleData = {
                    subjects: state.subjects.map(({ id, name, code, type, totalClasses, priority }) => ({ id, name, code, type, totalClasses, priority }))
                };

                try {
                    const scheduleDocRef = doc(db, 'schedules', code);
                    await setDoc(scheduleDocRef, scheduleData);
                    elements.settings.shareCodeDisplay.textContent = code;
                    showToast("Share code generated and saved!", "success");
                    saveData();
                } catch (error) {
                    console.error("Error saving share code to Firestore:", error);
                    showToast("Could not generate share code. Please try again.", "error");
                }
            }

            async function importWithCode() {
                const code = elements.settings.classCodeInput.value.trim().toUpperCase();
                if (!code) {
                    showToast("Please enter a class code.", "error");
                    return;
                }
                
                const scheduleDocRef = doc(db, 'schedules', code);
                try {
                    const docSnap = await getDoc(scheduleDocRef);
                    if (docSnap.exists()) {
                        const scheduleData = docSnap.data();
                        showOcrConfirmationModal(scheduleData.subjects);
                        showToast("Schedule loaded! Please confirm your current attendance status.", "success");
                        elements.settings.classCodeInput.value = '';
                    } else {
                        showToast("Invalid Class Code. Please check and try again.", "error");
                    }
                } catch (error) {
                    console.error("Error importing from Firestore:", error);
                    showToast("Could not import code. Please try again.", "error");
                }
            }
            
            function exportData(format) {
                const dataStr = JSON.stringify({ subjects: state.subjects, history: state.history, minAttendance: state.minAttendance }, null, 2);
                let content, filename, mimeType;

                if (format === 'json') {
                    content = dataStr;
                    filename = 'presentsir_data.json';
                    mimeType = 'application/json';
                } else if (format === 'csv') {
                    let csvContent = "Subject Name,Subject Code,Date,Status\n";
                    Object.entries(state.history).forEach(([key, status]) => {
                        const [subjectId, date] = key.split('-');
                        const subject = state.subjects.find(s => s.id == subjectId);
                        if (subject) {
                            csvContent += `"${subject.name}","${subject.code}",${date},${status}\n`;
                        }
                    });
                    content = csvContent;
                    filename = 'presentsir_data.csv';
                    mimeType = 'text/csv';
                }

                const blob = new Blob([content], { type: mimeType });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }

            //  FIX: Replaced window.confirm with a robust custom modal.
            function showConfirmModal(message, onConfirm) {
                elements.modal.content.innerHTML = `
                    <div class="text-center p-4">
                        <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100">
                            <i class="fas fa-exclamation-triangle text-red-600 text-xl"></i>
                        </div>
                        <h3 class="text-lg leading-6 font-medium text-gray-900 mt-4">Are you sure?</h3>
                        <div class="mt-2">
                            <p class="text-sm text-gray-500">${message}</p>
                        </div>
                        <div class="mt-6 flex justify-center space-x-4">
                            <button id="confirm-cancel-btn" class="px-4 py-2 bg-gray-200 text-gray-800 text-sm font-medium rounded-md hover:bg-gray-300">Cancel</button>
                            <button id="confirm-action-btn" class="px-4 py-2 bg-red-600 text-white text-sm font-medium rounded-md hover:bg-red-700">Yes, Reset Data</button>
                        </div>
                    </div>
                `;
                elements.modal.container.classList.remove('hidden');

                document.getElementById('confirm-action-btn').addEventListener('click', () => {
                    onConfirm();
                    closeModal();
                });
                document.getElementById('confirm-cancel-btn').addEventListener('click', closeModal);
            }

            //  FIX: The reset function now uses the confirmation modal and avoids re-saving data.
            function resetData() {
                showConfirmModal("This will delete all your subjects and attendance history. This action cannot be undone.", async () => {
                    console.log("Resetting all data...");
                    if (userId) {
                        const userDocRef = doc(db, 'users', userId);
                        try {
                            await deleteDoc(userDocRef);
                        } catch (e) {
                            console.error("Error deleting document:", e);
                            showToast("Could not reset data on the server.", "error");
                            return;
                        }
                    }
                    // Reset local state to default
                    Object.assign(state, {
                        minAttendance: 75,
                        subjects: [],
                        history: {},
                        lastAction: null,
                        shareCode: null
                    });
                    
                    // Manually re-render components instead of calling updateApp() to avoid saving the reset state.
                    renderDashboard();
                    renderDailyLog();
                    renderSettings();
                    if (activeTab === 'planner') renderPlanner();

                    showToast("All data has been reset.");
                });
            }

            function showMemeModal() {
                const memeId = new Date().getDate();
                elements.modal.content.innerHTML = `
                    <div class="text-center">
                        <h2 class="text-2xl font-bold text-gray-900">Daily Log Complete!</h2>
                        <p class="mt-2 text-gray-600">Here's your meme for the day. Keep up the great work!</p>
                        <img src="https://placehold.co/600x400/E2E8F0/4A5568?text=Quirky+Meme+%23${memeId}" alt="Daily Meme" class="mt-4 rounded-lg mx-auto shadow-lg">
                        <button id="close-modal-btn" class="mt-6 px-4 py-2 bg-indigo-600 text-white text-sm font-medium rounded-md hover:bg-indigo-700">Awesome!</button>
                    </div>
                `;
                elements.modal.container.classList.remove('hidden');
                document.getElementById('close-modal-btn').addEventListener('click', closeModal);
            }

            function closeModal() {
                elements.modal.container.classList.add('hidden');
                elements.modal.content.innerHTML = '';
                if (chartInstance) {
                    chartInstance.destroy();
                    chartInstance = null;
                }
            }

            function showSubjectDetail(subjectId) {
                showToast(`Showing details for subject ID ${subjectId}. Detail modal UI can be built here.`);
            }

            function switchTab(tabName) {
                activeTab = tabName;
                Object.values(elements.pages).forEach(page => page.classList.add('hidden'));
                Object.values(elements.tabs).forEach(tab => tab.classList.replace('tab-active', 'tab-inactive'));
                elements.pages[tabName].classList.remove('hidden');
                elements.tabs[tabName].classList.replace('tab-inactive', 'tab-active');
                if (tabName === 'planner') {
                    renderPlanner();
                }
            }

            function updateApp() {
                saveData();
                renderDashboard();
                renderDailyLog();
                renderSettings();
                if(activeTab === 'planner') renderPlanner();
            }
            
            function init() {
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        loadData();
                    } else {
                        signInAnonymously(auth).catch((error) => {
                            console.error("Anonymous sign-in failed:", error);
                            showToast("Could not connect to the database.", "error");
                        });
                    }
                });

                switchTab('dashboard');

                elements.kpi.periodToggle.addEventListener('click', (e) => {
                    if (e.target.tagName === 'BUTTON') {
                        activePeriod = e.target.dataset.period;
                        updateKPIs();
                    }
                });
                elements.dailyLog.undoBtn.addEventListener('click', undoLastAction);
                elements.planner.prevMonthBtn.addEventListener('click', () => { currentPlannerDate.setMonth(currentPlannerDate.getMonth() - 1); renderPlanner(); });
                elements.planner.nextMonthBtn.addEventListener('click', () => { currentPlannerDate.setMonth(currentPlannerDate.getMonth() + 1); renderPlanner(); });
                elements.settings.minAttendanceInput.addEventListener('change', (e) => { state.minAttendance = parseInt(e.target.value, 10); updateApp(); });
                elements.settings.processUploadsBtn.addEventListener('click', processUploads);
                elements.settings.importCodeBtn.addEventListener('click', importWithCode);
                elements.settings.addSubjectBtn.addEventListener('click', showAddSubjectModal);
                elements.settings.copyCodeBtn.addEventListener('click', () => { navigator.clipboard.writeText(state.shareCode); showToast('Class Code copied to clipboard!'); });
                elements.settings.exportCsvBtn.addEventListener('click', () => exportData('csv'));
                elements.settings.exportJsonBtn.addEventListener('click', () => exportData('json'));
                elements.settings.resetBtn.addEventListener('click', resetData);
                elements.modal.container.addEventListener('click', (e) => { if (e.target === elements.modal.container) closeModal(); });
                Object.keys(elements.tabs).forEach(tabName => {
                    elements.tabs[tabName].addEventListener('click', () => switchTab(tabName));
                });
            }

            init();
        });
    </script>
</body>
</html>
